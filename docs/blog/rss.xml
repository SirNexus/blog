<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="rss.xsl"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Aidan Carson Blog</title>
        <link>https://aidancarson.com/blog</link>
        <description>Aidan Carson Blog</description>
        <lastBuildDate>Fri, 13 Jun 2025 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Kind multi cluster flat network]]></title>
            <link>https://aidancarson.com/blog/kind-multi-cluster-flat-network</link>
            <guid>https://aidancarson.com/blog/kind-multi-cluster-flat-network</guid>
            <pubDate>Fri, 13 Jun 2025 00:00:00 GMT</pubDate>
            <category>Kind</category>
            <category>Kubernetes</category>
            <category>Networking</category>
            <category>Pod</category>
            <category>Linux</category>
        </item>
        <item>
            <title><![CDATA[Enabling pod to pod mTLS in Istio]]></title>
            <link>https://aidancarson.com/blog/istio-pod-to-pod-mtls</link>
            <guid>https://aidancarson.com/blog/istio-pod-to-pod-mtls</guid>
            <pubDate>Tue, 29 Apr 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Imagine a situation where you have multiple different clusters, each running]]></description>
            <content:encoded><![CDATA[<p>Imagine a situation where you have multiple different clusters, each running
an Istio service mesh and which are federated together to talk to each other.
Now also imagine that these clusters are networked together such that each
pod IP is uniquely addressable and able to be communicated with from any other
cluster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="https://aidancarson.com/blog/istio-pod-to-pod-mtls#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2>
<p>I faced a situation like this, where I needed to group endpoints into logical
hostnames that represented services backed by those endpoints. Because endpoints
could live anywhere, in any cluster, I landed on using a ServiceEntry to register
the hostname and WorkloadEntries to represent the endpoints service that hostname.</p>
<p>But a problem came on enabling PeerAuthentication:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> security.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PeerAuthentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prod</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">istio</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system </span><span class="token comment" style="color:#999988;font-style:italic"># The namespace of our istio installation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">mtls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> STRICT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Curl stopped working!</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl global-echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Through some debugging, I was able to get it to:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl global-echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. retried and the latest reset reason: remote connection failure, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transport failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But to find the true root cause and solution took some digging.</p>
<p>Let's get into it</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup">Setup<a href="https://aidancarson.com/blog/istio-pod-to-pod-mtls#setup" class="hash-link" aria-label="Direct link to Setup" title="Direct link to Setup">​</a></h2>
<p>The configuration looked something like this:</p>
<p>ServiceEntry:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceEntry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">creationTimestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2025-04-29T17:01:04Z"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">generation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">curl</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resourceVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7068"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 9c26a814</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e852</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">4903</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">81a9</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">9213987236a0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">location</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MESH_INTERNAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resolution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> STATIC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">subjectAltNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> spiffe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//cluster.local/ns/echo/sa/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> spiffe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//cluster.local/ns/echo/sa/default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">workloadSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">addresses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 240.240.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 2001</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourceVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>WorkloadEntry:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME                              AGE     ADDRESS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">global-echo-cluster1-10.4.2.45    4m58s   10.4.2.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">global-echo-cluster2-10.6.1.212   27m     10.6.1.212</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WorkloadEntry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">creationTimestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2025-04-29T17:24:24Z"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">generation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">10.4.2.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resourceVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7188"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> d8c0a5da</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">aab8</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">4338</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b890</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">b597a7883f47</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.4.2.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WorkloadEntry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">creationTimestamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2025-04-29T17:01:43Z"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">generation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">10.6.1.212</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">resourceVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"7189"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">uid</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 72ff1595</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e098</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">4eb2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">9f84</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f251d3c8faf4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.6.1.212</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> List</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resourceVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These resources specify a host <code>global-echo</code>, and two backend services each of which
live in their own clusters. Behind the scenes, I have these services running simple
echo servers. If you'd like that yaml, here it is:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hashicorp/http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">text=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .CurCluster </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">listen=</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"100m"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"100Mi"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"100m"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"100Mi"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And it works! I can curl both pods in my mesh:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">for i in {1..10}; do curl global-echo; done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem">The Problem<a href="https://aidancarson.com/blog/istio-pod-to-pod-mtls#the-problem" class="hash-link" aria-label="Direct link to The Problem" title="Direct link to The Problem">​</a></h2>
<p>So networking is working. Istio is generating the correct Envoy config such that
our global hostname routes to our backing services on each cluster. But what about
security? Just to make sure that Istio is actually performing mTLS between pods,
let's turn on strict mTLS.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: security.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PeerAuthentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: prod-istio-system # The namespace of our istio installation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  mtls:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mode: STRICT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let's check that our communication still works:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ for i in {1..10}; do curl global-echo; done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Our connection broke! What gives! I thought Istio was routing our services? Spoiler:
our connection broke because istio was using PERMISSIVE mode and sending our traffic
over plaintext. Now that we are enforcing STRICT mTLS mode, Istio is breaking.
This means that we weren't secure before, sending traffic over plaintext. This is
super interesting. Istio should be handling the upgrading of our communication to
mTLS by default. So what's happening? Let's do some testing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="finding-the-solution">Finding the Solution<a href="https://aidancarson.com/blog/istio-pod-to-pod-mtls#finding-the-solution" class="hash-link" aria-label="Direct link to Finding the Solution" title="Direct link to Finding the Solution">​</a></h2>
<p>So let's look at the local endpoint. Curling from cluster1, we have a local echo
pod IP of <code>10.4.2.45</code>. Let's curl that:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl 10.4.2.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. reset reason: connection termination</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hm, so that's broken. That makes sense, since the service entry is just resolving
DNS requests to the WorkloadEntry specifying <code>curl 10.4.2.45</code>.</p>
<p>But now let's try the echo service itself:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl echo.echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That works! How strange! So istio is <em>capable</em> of routing our traffic over mTLS,
it just isn't when connecting to the <strong>pod IP</strong> rather than service.</p>
<p>Okay, so what about service IP? Let's get the ip of the associated echo service:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get svc -n echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo            ClusterIP   10.5.113.88   &lt;none&gt;        80/TCP    48m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And now let's curl that:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl 10.5.113.88</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That also works! So from this we can conclude that Istio is routing things correctly
when using the service name or service IP, but not when using the pod IP. Upon further
reflection on the Istio documentation on <a href="https://istio.io/latest/docs/reference/config/networking/workload-entry/" target="_blank" rel="noopener noreferrer">WorkloadEntry</a>,
these lines stand out:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # use of the service account indicates that the workload has a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # sidecar proxy bootstrapped with this service account. Pods with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # sidecars will automatically communicate with the workload using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # istio mutual TLS.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccount: details-legacy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This means that when working with a WorkloadEntry, Istio looks for a serviceAccount
associated with the pod to communicate over mTLS. So let's add that:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WorkloadEntry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster1</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">10.4.2.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.4.2.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> client </span><span class="token comment" style="color:#999988;font-style:italic"># &lt;-----   Added this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WorkloadEntry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">10.6.1.212</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">address</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.6.1.212</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceAccount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> client </span><span class="token comment" style="color:#999988;font-style:italic"># &lt;-----   Added this</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let's try our global-echo curl:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl global-echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstream connect error or disconnect/reset before headers. retried and the latest reset reason: remote connection failure, transport failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Weird. Now we're getting a certificate issue. I suppose this means Istio is <em>trying</em>
to communicate with the pod over mTLS, but there's clearly a certificate issue going wrong.
It's time to look at the Istio logs.</p>
<p>On a successful request (<code>curl 10.5.113.88</code>), we see Istio logs coming from the client
sidecar:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975202Z	debug	envoy filter external/envoy/source/extensions/filters/listener/original_dst/original_dst.cc:69	original_dst: set destination to 10.5.113.88:80	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975404Z	debug	envoy filter external/envoy/source/extensions/filters/listener/http_inspector/http_inspector.cc:139	http inspector: set application protocol to http/1.1	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975558Z	debug	envoy conn_handler external/envoy/source/common/listener_manager/active_tcp_listener.cc:160	[Tags: "ConnectionId":"192"] new connection from 10.4.2.55:49952	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975643Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:393	[Tags: "ConnectionId":"192"] new stream	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975821Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1183	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] request headers complete (end_stream=true):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':authority', '10.5.113.88'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':path', '/'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':method', 'GET'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'user-agent', 'curl/8.7.1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'accept', '*/*'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975840Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1166	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] request end stream timestamp recorded	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975870Z	debug	envoy connection external/envoy/source/common/network/connection_impl.h:98	[Tags: "ConnectionId":"192"] current connecting state: false	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975922Z	debug	envoy filter source/extensions/filters/http/alpn/alpn_filter.cc:92	override with 3 ALPNs	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975938Z	debug	envoy router external/envoy/source/common/router/router.cc:527	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] cluster 'outbound|80||echo.echo.svc.cluster.local' match for URL '/'	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.975979Z	debug	envoy router external/envoy/source/common/router/router.cc:756	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] router decoding headers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':authority', '10.5.113.88'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':path', '/'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':method', 'GET'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':scheme', 'http'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'user-agent', 'curl/8.7.1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'accept', '*/*'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-forwarded-proto', 'http'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-request-id', '79f4055e-4122-4096-af82-6dcbebeb8498'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-decorator-operation', 'echo.echo.svc.cluster.local:80/*'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-peer-metadata-id', 'sidecar~10.4.2.55~client-f4cd469d6-wnsrx.curl~curl.svc.cluster.local'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-peer-metadata', 'ChoKCkNMVVNURVJfSUQSDBoKS3ViZXJuZXRlcwqIAQoGTEFCRUxTEn4qfAoPCgNhcHASCBoGY2xpZW50CisKH3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLW5hbWUSCBoGY2xpZW50CisKI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEgQaAnYxCg8KB3ZlcnNpb24SBBoCdjEKIAoETkFNRRIYGhZjbGllbnQtZjRjZDQ2OWQ2LXduc3J4ChMKCU5BTUVTUEFDRRIGGgRjdXJsCkcKBU9XTkVSEj4aPGt1YmVybmV0ZXM6Ly9hcGlzL2FwcHMvdjEvbmFtZXNwYWNlcy9jdXJsL2RlcGxveW1lbnRzL2NsaWVudAoZCg1XT1JLTE9BRF9OQU1FEggaBmNsaWVudA=='</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-attempt-count', '1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.976066Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:265	[Tags: "ConnectionId":"181"] using existing fully connected connection	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.976071Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:182	[Tags: "ConnectionId":"181"] creating stream	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.976084Z	debug	envoy router external/envoy/source/common/router/upstream_request.cc:593	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] pool ready	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.976117Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:142	[Tags: "ConnectionId":"181"] encode complete	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977190Z	debug	envoy router external/envoy/source/common/router/router.cc:1559	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] upstream headers complete: end_stream=false	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977274Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1878	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] encoding headers via codec (end_stream=false):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':status', '200'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-app-name', 'http-echo'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-app-version', '1.0.0'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'date', 'Tue, 29 Apr 2025 17:44:56 GMT'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'content-length', '9'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'content-type', 'text/plain; charset=utf-8'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-upstream-service-time', '1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'server', 'envoy'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977301Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:129	[Tags: "ConnectionId":"181"] response complete	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977316Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1993	[Tags: "ConnectionId":"192","StreamId":"12612765843006107830"] Codec completed encoding stream.	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977361Z	debug	envoy pool external/envoy/source/common/http/http1/conn_pool.cc:53	[Tags: "ConnectionId":"181"] response complete	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977368Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:215	[Tags: "ConnectionId":"181"] destroying stream: 0 remaining	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977832Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:714	[Tags: "ConnectionId":"192"] remote close	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977856Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:276	[Tags: "ConnectionId":"192"] closing socket: 0	thread=28</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T17:44:56.977944Z	debug	envoy conn_handler external/envoy/source/common/listener_manager/active_stream_listener_base.cc:136	[Tags: "ConnectionId":"192"] adding to cleanup list	thread=28</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note particularly the line <code>cluster 'outbound|80||echo.echo.svc.cluster.local' match for URL '/'	thread=28</code>.
This gives us some important information. Even on an IP route to the service,
Istio is matching the request to the outbound service it has configured.</p>
<p>Let's compare that to the log when we send a request to the <code>global-echo</code> service:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.944432Z	debug	envoy filter external/envoy/source/extensions/filters/listener/original_dst/original_dst.cc:69	original_dst: set destination to 240.240.0.1:80	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.944666Z	debug	envoy filter external/envoy/source/extensions/filters/listener/http_inspector/http_inspector.cc:139	http inspector: set application protocol to http/1.1	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.944853Z	debug	envoy conn_handler external/envoy/source/common/listener_manager/active_tcp_listener.cc:160	[Tags: "ConnectionId":"446"] new connection from 10.4.2.55:35226	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.944900Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:393	[Tags: "ConnectionId":"446"] new stream	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.944966Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1183	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] request headers complete (end_stream=true):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':authority', 'global-echo'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':path', '/'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':method', 'GET'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'user-agent', 'curl/8.7.1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'accept', '*/*'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.944980Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1166	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] request end stream timestamp recorded	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945014Z	debug	envoy connection external/envoy/source/common/network/connection_impl.h:98	[Tags: "ConnectionId":"446"] current connecting state: false	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945174Z	debug	envoy filter source/extensions/filters/http/alpn/alpn_filter.cc:92	override with 3 ALPNs	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945206Z	debug	envoy router external/envoy/source/common/router/router.cc:527	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] cluster 'outbound|80||global-echo' match for URL '/'	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945308Z	debug	envoy router external/envoy/source/common/router/router.cc:756	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] router decoding headers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':authority', 'global-echo'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':path', '/'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':method', 'GET'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':scheme', 'http'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'user-agent', 'curl/8.7.1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'accept', '*/*'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-forwarded-proto', 'http'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-request-id', 'c7b51081-47e1-491b-ba1e-a87bd4608220'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-decorator-operation', 'global-echo:80/*'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-peer-metadata-id', 'sidecar~10.4.2.55~client-f4cd469d6-wnsrx.curl~curl.svc.cluster.local'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-peer-metadata', 'ChoKCkNMVVNURVJfSUQSDBoKS3ViZXJuZXRlcwqIAQoGTEFCRUxTEn4qfAoPCgNhcHASCBoGY2xpZW50CisKH3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLW5hbWUSCBoGY2xpZW50CisKI3NlcnZpY2UuaXN0aW8uaW8vY2Fub25pY2FsLXJldmlzaW9uEgQaAnYxCg8KB3ZlcnNpb24SBBoCdjEKIAoETkFNRRIYGhZjbGllbnQtZjRjZDQ2OWQ2LXduc3J4ChMKCU5BTUVTUEFDRRIGGgRjdXJsCkcKBU9XTkVSEj4aPGt1YmVybmV0ZXM6Ly9hcGlzL2FwcHMvdjEvbmFtZXNwYWNlcy9jdXJsL2RlcGxveW1lbnRzL2NsaWVudAoZCg1XT1JLTE9BRF9OQU1FEggaBmNsaWVudA=='</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'x-envoy-attempt-count', '1'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945334Z	debug	envoy pool external/envoy/source/common/http/conn_pool_base.cc:78	queueing stream due to no available connections (ready=0 busy=0 connecting=0)	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945342Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:291	trying to create new connection	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945346Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:145	creating a new connection (connecting=0)	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945472Z	debug	envoy connection external/envoy/source/common/network/connection_impl.h:98	[Tags: "ConnectionId":"447"] current connecting state: true	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945480Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:57	[Tags: "ConnectionId":"447"] connecting	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945488Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:1017	[Tags: "ConnectionId":"447"] connecting to 10.4.2.45:8080	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945663Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:1036	[Tags: "ConnectionId":"447"] connection in progress	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.945707Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:746	[Tags: "ConnectionId":"447"] connected	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947216Z	debug	envoy connection external/envoy/source/common/tls/cert_validator/default_validator.cc:246	verify cert failed: SAN matcher	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947284Z	debug	envoy connection external/envoy/source/common/tls/ssl_socket.cc:246	[Tags: "ConnectionId":"447"] remote address:10.4.2.45:8080,TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947297Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:276	[Tags: "ConnectionId":"447"] closing socket: 0	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947340Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:107	[Tags: "ConnectionId":"447"] disconnect. resetting 0 pending requests	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947378Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:495	[Tags: "ConnectionId":"447"] client disconnected, failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947403Z	debug	envoy router external/envoy/source/common/router/router.cc:1384	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] upstream reset: reset reason: remote connection failure, transport failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947452Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:463	invoking 1 idle callback(s) - is_draining_for_deletion_=false	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962109Z	debug	envoy router external/envoy/source/common/router/router.cc:2013	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] performing retry	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962200Z	debug	envoy pool external/envoy/source/common/http/conn_pool_base.cc:78	queueing stream due to no available connections (ready=0 busy=0 connecting=0)	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962208Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:291	trying to create new connection	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962210Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:145	creating a new connection (connecting=0)	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962340Z	debug	envoy connection external/envoy/source/common/network/connection_impl.h:98	[Tags: "ConnectionId":"448"] current connecting state: true	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962504Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:57	[Tags: "ConnectionId":"448"] connecting	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962520Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:1017	[Tags: "ConnectionId":"448"] connecting to 10.4.2.45:8080	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962810Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:1036	[Tags: "ConnectionId":"448"] connection in progress	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.962854Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:746	[Tags: "ConnectionId":"448"] connected	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.964802Z	debug	envoy connection external/envoy/source/common/tls/cert_validator/default_validator.cc:246	verify cert failed: SAN matcher	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.964857Z	debug	envoy connection external/envoy/source/common/tls/ssl_socket.cc:246	[Tags: "ConnectionId":"448"] remote address:10.4.2.45:8080,TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.964861Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:276	[Tags: "ConnectionId":"448"] closing socket: 0	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.965002Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:107	[Tags: "ConnectionId":"448"] disconnect. resetting 0 pending requests	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.965017Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:495	[Tags: "ConnectionId":"448"] client disconnected, failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.965098Z	debug	envoy router external/envoy/source/common/router/router.cc:1384	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] upstream reset: reset reason: remote connection failure, transport failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.965141Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:463	invoking 1 idle callback(s) - is_draining_for_deletion_=false	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013428Z	debug	envoy router external/envoy/source/common/router/router.cc:2013	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] performing retry	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013521Z	debug	envoy pool external/envoy/source/common/http/conn_pool_base.cc:78	queueing stream due to no available connections (ready=0 busy=0 connecting=0)	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013525Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:291	trying to create new connection	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013547Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:145	creating a new connection (connecting=0)	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013729Z	debug	envoy connection external/envoy/source/common/network/connection_impl.h:98	[Tags: "ConnectionId":"449"] current connecting state: true	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013755Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:57	[Tags: "ConnectionId":"449"] connecting	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.013761Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:1017	[Tags: "ConnectionId":"449"] connecting to 10.4.2.45:8080	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.014191Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:1036	[Tags: "ConnectionId":"449"] connection in progress	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.014216Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:746	[Tags: "ConnectionId":"449"] connected	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.015911Z	debug	envoy connection external/envoy/source/common/tls/cert_validator/default_validator.cc:246	verify cert failed: SAN matcher	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016058Z	debug	envoy connection external/envoy/source/common/tls/ssl_socket.cc:246	[Tags: "ConnectionId":"449"] remote address:10.4.2.45:8080,TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016062Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:276	[Tags: "ConnectionId":"449"] closing socket: 0	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016113Z	debug	envoy client external/envoy/source/common/http/codec_client.cc:107	[Tags: "ConnectionId":"449"] disconnect. resetting 0 pending requests	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016138Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:495	[Tags: "ConnectionId":"449"] client disconnected, failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016155Z	debug	envoy router external/envoy/source/common/router/router.cc:1384	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] upstream reset: reset reason: remote connection failure, transport failure reason: TLS_error:|268435581:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016271Z	debug	envoy http external/envoy/source/common/http/filter_manager.cc:1084	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] Sending local reply with details upstream_reset_before_response_started{remote_connection_failure|TLS_error:|268435581:SSL_routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED:TLS_error_end}	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016338Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1878	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] encoding headers via codec (end_stream=false):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">':status', '503'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'content-length', '239'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'content-type', 'text/plain'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'date', 'Tue, 29 Apr 2025 18:08:46 GMT'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">'server', 'envoy'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016377Z	debug	envoy http external/envoy/source/common/http/conn_manager_impl.cc:1993	[Tags: "ConnectionId":"446","StreamId":"5689876678243589196"] Codec completed encoding stream.	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.016499Z	debug	envoy pool external/envoy/source/common/conn_pool/conn_pool_base.cc:463	invoking 1 idle callback(s) - is_draining_for_deletion_=false	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.017236Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:714	[Tags: "ConnectionId":"446"] remote close	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.017259Z	debug	envoy connection external/envoy/source/common/network/connection_impl.cc:276	[Tags: "ConnectionId":"446"] closing socket: 0	thread=29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:47.017318Z	debug	envoy conn_handler external/envoy/source/common/listener_manager/active_stream_listener_base.cc:136	[Tags: "ConnectionId":"446"] adding to cleanup list	thread=29</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see, the request is being handled by the <code>outbound|80||global-echo</code> cluster,
and yet the upstream server is still responding with a 503. There is a pertinent
part here that hints at what might be going wrong:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2025-04-29T18:08:46.947216Z	debug	envoy connection external/envoy/source/common/tls/cert_validator/default_validator.cc:246	verify cert failed: SAN matcher	thread=29</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>our SAN isn't getting matched. For anyone not super familiar, a
SAN stands for Subject Alternative Name. It is an extension in X.509 certificates (used in TLS/SSL) that allows you to
specify additional identities (such as DNS names, IP addresses, or URIs) that the certificate should be valid for,
beyond the primary Common Name (CN). Istio uses this to verify the spiffeID
associated with the serviceAccount used in the mTLS handshake.</p>
<p>Let's debug the cluster configuration next in envoy and see if there's a difference.</p>
<p>(Commands gotten with <code>istioctl pc cluster -n curl curl-f4cd469d6-wnsrx --fqdn echo.echo.svc.cluster.local -o j son</code>)</p>
<p>Diff between cluster configs of not working (<code>-</code>) and not working (<code>+</code>)</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                  "defaultValidationContext": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "matchSubjectAltNames": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-                       "exact": "spiffe://cluster.local/ns/curl/sa/curl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "defaultValidationContext": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "matchSubjectAltNames": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+                       "exact": "spiffe://cluster.local/ns/echo/sa/default"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  },</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>(Note the output has been cleaned to show the pertinent, non-trivial parts)</p>
<p>This is the key. Inside of Istio's tls configuration, the configured SAN in
the working configuration is associated with the <em>destination</em> service account,
while in the non-working configuration, it is associated with the <em>source</em> service account.</p>
<p>According to the Istio documentation, we can edit the SAN inside of our ServiceEntry:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.istio.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceEntry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">curl</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> curl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hosts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">location</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MESH_INTERNAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resolution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> STATIC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">subjectAltNames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> spiffe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//cluster.local/ns/echo/sa/default </span><span class="token comment" style="color:#999988;font-style:italic"># &lt;----- Added this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">workloadSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">global-service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And once that's applied, we can test our custom host:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl global-echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It works! So now we have a custom host routing directly between pod IPs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://aidancarson.com/blog/istio-pod-to-pod-mtls#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>In this post, we learned how to set up a custom host in Istio that routes between
two different clusters. We learned how to set up a ServiceEntry and WorkloadEntry
to route between the two clusters, and how to set up a custom SAN in the ServiceEntry
to allow for mTLS communication between the two clusters. We also learned how to
debug the Istio configuration to find out what was going wrong with our mTLS
configuration, and how to fix it by adding the correct SAN to the ServiceEntry.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="related-issues">Related Issues<a href="https://aidancarson.com/blog/istio-pod-to-pod-mtls#related-issues" class="hash-link" aria-label="Direct link to Related Issues" title="Direct link to Related Issues">​</a></h3>
<ul>
<li><a href="https://github.com/istio/istio/issues/37431" target="_blank" rel="noopener noreferrer">https://github.com/istio/istio/issues/37431</a></li>
<li><a href="https://discuss.istio.io/t/503-between-pod-to-pod-communication-1-5-1/6121" target="_blank" rel="noopener noreferrer">https://discuss.istio.io/t/503-between-pod-to-pod-communication-1-5-1/6121</a></li>
<li><a href="https://stackoverflow.com/questions/62881298/what-is-pod-to-pod-encryption-in-kubernetes-and-how-to-implement-pod-to-pod-enc" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/62881298/what-is-pod-to-pod-encryption-in-kubernetes-and-how-to-implement-pod-to-pod-enc</a></li>
</ul>]]></content:encoded>
            <category>Istio</category>
            <category>ServiceEntry</category>
            <category>pod</category>
            <category>mTLS</category>
            <category>strict</category>
            <category>authentication</category>
        </item>
    </channel>
</rss>